<!doctype html>
<html>
<head>
    <title>API Key Tester</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="theme-switch-wrapper">
        <label class="theme-switch" for="checkbox">
            <input type="checkbox" id="checkbox" />
            <div class="slider round"></div>
        </label>
    </div>
    <div class="container">
        <h1>Gemini API Key Tester</h1>
        <form id="apiForm" method="POST" action="/">
            <label for="api_key">API Key:</label>
            <input type="text" id="api_key" name="api_key" value="{{ api_key or '' }}" required>

            <label for="key_name">Key Name (Optional):</label>
            <input type="text" id="key_name" name="key_name" placeholder="Recommended to put account name.">

            <label for="prompt">Prompt:</label>
            <textarea id="prompt" name="prompt" rows="4" required>Explain how AI works in a few words</textarea>

            <div class="save-key-wrapper">
                <input type="checkbox" id="save_key" name="save_key" value="true">
                <label for="save_key">Save API Key to Database</label>
            </div>

            <button type="submit">Test API Key</button>
        </form>


        {% if result %}
        <details class="results">
            <summary>
                Test Results: <span class="status-{{ result.status }}">{{ result.status.capitalize() }} </span> (Click to show more detail)
            </summary>
            <p><strong>Message:</strong> {{ result.message }}</p>
            {% if result.api_response %}
                <h3>API Response Details:</h3>
                <pre>{{ result.api_response | tojson(indent=2) }}</pre>
            {% endif %}
        </details>
        {% endif %}
    </div>

    <div class="container" style="margin-top: 2rem;">
        <h2>Saved API Keys</h2>

        <form action="/" method="GET" class="search-form">
            <input type="text" name="search" placeholder="Search API Keys" value="{{ search }}">
            <button type="submit">Search</button>
            {% if search %}
                <a href="/" class="clear-search">Clear Search</a>
            {% endif %}
        </form>

        <div class="keys-list">
            {% if keys %}
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>API Key (Partial)</th>
                            <th>Status</th>
                            <th>Last Checked</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for key in keys %}
                            <tr>
                                <td>{{ key['name'] }}</td>
                                <td>{{ key['key'][:4] }}...{{ key['key'][-4:] }}</td>
                                <td><span class="status-{{ key['status'] }}">{{ key['status'].capitalize() }}</span></td>
                                <td>{{ key['last_checked'] }}</td>
                                <td class="actions">
                                    <a href="/?api_key={{ key['key'] }}&search={{search}}&page={{page}}" class="button-link">Test</a>
                                    <button type="button" class="button-link edit-btn" data-key-id="{{ key['id'] }}">Edit</button>
                                    <form action="{{ url_for('delete_key', key_id=key['id']) }}" method="POST" style="display:inline;">
                                        <button type="submit" class="delete-btn">Delete</button>
                                    </form>
                                    <form class="edit-form" data-key-id="{{ key['id'] }}" action="{{ url_for('update_key', key_id=key['id']) }}" method="POST" style="display:none;">
                                        <input type="text" name="new_api_key" placeholder="New API Key" required>
                                        <button type="submit" class="update-btn">Update</button>
                                        <div class="error-message" style="color: red; display: none;">New API key cannot be the same as the old one.</div>
                                    </form>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p>No API keys saved yet.</p>
            {% endif %}
        </div>

        <div class="pagination">
            {% if page > 1 %}
                <a href="/?page={{ page - 1 }}&search={{search}}" class="page-link">Previous</a>
            {% endif %}

            {% set num_pages = (total_keys / page_size)|round(method='ceil')|int %}
            {% for p in range(1, num_pages + 1) %}
                <a href="/?page={{ p }}&search={{search}}" class="page-link {% if p == page %}active{% endif %}">{{ p }}</a>
            {% endfor %}

            {% if page * page_size < total_keys %}
                <a href="/?page={{ page + 1 }}&search={{search}}" class="page-link">Next</a>
            {% endif %}
        </div>
    </div>
    <script>
        const checkbox = document.getElementById('checkbox');
        const body = document.body;

        // Function to set the theme
        function setTheme(theme) {
            if (theme === 'dark') {
                body.classList.add('dark-mode');
            } else {
                body.classList.remove('dark-mode');
            }
        }

        // Check local storage for theme
        const storedTheme = localStorage.getItem('theme');
        if (storedTheme) {
            setTheme(storedTheme);
            checkbox.checked = storedTheme === 'dark';
        }

        // Listen for changes on the checkbox
        checkbox.addEventListener('change', function() {
            if (this.checked) {
                setTheme('dark');
                localStorage.setItem('theme', 'dark');
            } else {
                setTheme('light');
                localStorage.setItem('theme', 'light');
            }
        });

        // Edit API Key functionality
        const editButtons = document.querySelectorAll('.edit-btn');
        editButtons.forEach(button => {
            button.addEventListener('click', function(event) {
                event.preventDefault(); // Prevent default action
                const keyId = this.dataset.keyId;
                const row = this.closest('tr');
                const editForm = row.querySelector('.edit-form');
                const apiKeyCell = row.querySelector('td:nth-child(2)'); // Select the second td (API Key)
                const oldApiKey = apiKeyCell.textContent.replace('...', ''); // Extract the old API key
                const newApiKeyInput = editForm.querySelector('input[name="new_api_key"]');
                const updateButton = editForm.querySelector('.update-btn');
                const errorMessage = editForm.querySelector('.error-message');

                editForm.style.display = 'inline';

                // Function to validate if the new API key is the same as the old one
                function validateApiKey() {
                    if (newApiKeyInput.value === oldApiKey) {
                        updateButton.disabled = true;
                        errorMessage.style.display = 'block';
                    } else {
                        updateButton.disabled = false;
                        errorMessage.style.display = 'none';
                    }
                }

                // Validate on input change
                newApiKeyInput.addEventListener('input', validateApiKey);

                // Initial validation
                validateApiKey();
            });
        });
    </script>
</body>
</html>